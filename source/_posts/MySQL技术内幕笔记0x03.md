---
title: MySQL技术内幕笔记0x03
date: 2019-09-05 09:06:50
categories: 数据库
tags:
  - MySQL
  - InnoDB
  - 锁
---

# 锁

## 锁简介

- 锁是数据库区别于文件系统的一个关键特性。数据库系统使用锁是为了支持对共享资源进行并发访问，提供数据的完整性和一致性。

## lock与latch

- latch一般成为闩锁（轻量级锁），因为其要求锁定的时间必须非常短。若持续时间长，则应用的性能会非常差。其目的是保证并发线程操作临界资源的正确性，并且通常没有死锁检测机制。在InnoDB中，latch又可以分为mutex（互斥锁）和rwlock（读写锁）。 
- lock的对象是是事物，用来锁定的是数据库中的对象，如表、页、行。一般lock的对象仅在事物commit或rollback后进行释放（不同事物隔离级别释放的时间可能不同）。此外，lock是有死锁机制的。

## InnoDB存储引擎中的锁

### 锁的类型

- InnoDB实现了如下两种标准的行级锁：
  - 共享锁（S Lock），允许事物读一行数据。
  - 排他锁（X Lock），允许事物删除或更新一行数据。
- InnoDB支持多粒度锁定，这种锁定允许事物在行级锁与表级锁同时存在。为了支持在不同粒度上进行加锁操作，InnoDB支持一种额外的锁方式，称之为意向锁。意向锁是将锁定的对象分为多个层次，意向锁意味着事物希望在更细粒度上进行加锁。InnoDB支持两种意向锁：
  - 意向共享锁（IS Lock），事物想要夺得一张表中某几行的共享锁。
  - 意向排他锁（IX Lock），事物想要获得一张表中某几行的排他锁。
- 意向锁不会阻塞除全表扫描以外的任何请求。表级意向锁之间互相兼容，IS与S兼容，S与S兼容，其他情况都不兼容。

### 一致性非锁定读

- 一致性非锁定读是指InnoDB通过行的多版本控制的方式来读取当前数据库中行的数据。如果读取的行正在执行delete或update操作，这时读取操作不会因此去等待行锁释放，而是去读取行的快照数据。该操作实现是通过undo段来完成的，而undo用来在事物中回滚数据，因此快照数据本身是没有额外开销的。此外，读取快照数据是不需要上锁的，因为没有事物需要对历史数据进行修改。由此，非锁定读机制极大地提高了数据库的并发性。

### 一致性锁定读

- InnoDB对于select语句支持两种一致性锁定读操作，一种是`select ... for update`，对读取的行记录加一个X锁，其他事物不能对已锁定的行加上任何锁。另一种是`select ... lock in share mode`，对读取的行记录加一个S锁，其他事物可以向被锁定的行加S锁，但是如果加X锁则会被阻塞。